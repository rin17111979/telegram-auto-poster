name: Auto Post to Telegram

on:
  schedule:
    - cron: '0 7 */2 * *'  # Каждые 2 дня в 7:00 UTC (10:00 МСК)
  workflow_dispatch:       # Возможность запустить вручную

jobs:
  post:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Read posts
        run: |
          POST_COUNT=$(wc -l < posts.txt)
          LAST_POST=$(date +%s | md5sum | cut -d' ' -f1 | od -An -tu4 -N4 | tr -d ' ')
          POST_INDEX=$((LAST_POST % POST_COUNT + 1))
          sed -n "${POST_INDEX}p" posts.txt > current_post.txt
          echo "POST_INDEX=$POST_INDEX" >> $GITHUB_ENV

      - name: Send to Telegram
        run: |
          POST=$(cat current_post.txt | sed 's/^[0-9]*\. //')
          curl -s -X POST \
            https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
            -d chat_id=${{ secrets.TELEGRAM_CHANNEL }} \
            -d text="$POST" \
            -d parse_mode=HTML
