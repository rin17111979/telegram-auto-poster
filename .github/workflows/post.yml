name: Auto Post to Telegram

on:
  schedule:
    - cron: '0 7 */2 * *'  # каждые 2 дня в 10:00 МСК
  workflow_dispatch:

jobs:
  post:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Select random post
        id: select
        run: |
          # Разделяем posts.txt на блоки по пустой строке
          awk -v RS="" '{print > "post_" NR ".txt"}' posts.txt
          # Считаем количество постов
          COUNT=$(ls post_*.txt 2>/dev/null | wc -l)
          if [ "$COUNT" -eq 0 ]; then
            echo "❌ Нет постов!"
            exit 1
          fi
          # Выбираем случайный
          RANDOM_INDEX=$((RANDOM % COUNT + 1))
          SELECTED="post_${RANDOM_INDEX}.txt"
          # Читаем весь текст поста
          POST=$(cat "$SELECTED")
          # Сохраняем в переменную окружения (без экранирования — curl сделает это сам)
          echo "POST<<EOF" >> $GITHUB_ENV
          echo "$POST" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Send to Telegram
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHANNEL: ${{ secrets.TELEGRAM_CHANNEL }}
        run: |
          # Используем --data-urlencode для корректной передачи многострочного текста
          curl -s -X POST \
            "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            --data-urlencode "chat_id=${TELEGRAM_CHANNEL}" \
            --data-urlencode "text=${POST}" \
            --data-urlencode "parse_mode=HTML"
