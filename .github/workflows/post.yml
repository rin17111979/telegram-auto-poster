name: Auto Post to Telegram

on:
  schedule:
    - cron: '0 7 */2 * *'  # каждые 2 дня в 10:00 МСК
  workflow_dispatch:

jobs:
  post:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Select random post
        id: select
        run: |
          # Разделяем posts.txt на временные файлы по пустой строке
          csplit -f post_ -b '%d.txt' posts.txt '/^$/' {*} 2>/dev/null || true
          # Удаляем пустые файлы
          for f in post_*.txt; do
            if [ ! -s "$f" ]; then
              rm "$f"
            fi
          done
          # Считаем количество постов
          COUNT=$(ls post_*.txt 2>/dev/null | wc -l)
          if [ "$COUNT" -eq 0 ]; then
            echo "Нет постов!"
            exit 1
          fi
          # Выбираем случайный
          RANDOM_INDEX=$((RANDOM % COUNT + 1))
          SELECTED="post_$(printf "%0*d" 1 $((RANDOM_INDEX - 1))).txt"
          # Читаем и экранируем переносы для curl
          POST=$(cat "$SELECTED" | sed ':a;N;$!ba;s/\n/\\n/g')
          echo "POST<<EOF" >> $GITHUB_ENV
          echo "$POST" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Send to Telegram
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHANNEL: ${{ secrets.TELEGRAM_CHANNEL }}
        run: |
          curl -s -X POST \
            "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHANNEL}" \
            -d text="${POST}" \
            -d parse_mode=HTML
